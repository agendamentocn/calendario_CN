import { useState, useEffect } from 'react';
import { ChevronLeft, ChevronRight, Plus, Trash2, X, AlertTriangle, Sparkles } from 'lucide-react';
import { format, startOfMonth, endOfMonth, eachDayOfInterval, getDay, isSameDay } from 'date-fns';
import { ptBR } from 'date-fns/locale';

// Firebase imports
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc } from 'firebase/firestore';

// Main application component for the calendar
export default function App() {
    const [currentDate, setCurrentDate] = useState(new Date());
    const [events, setEvents] = useState({}); // Stores events by date: { 'YYYY-MM-DD': [{ id, name, whatsapp, ... }] }
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [selectedDate, setSelectedDate] = useState(null);
    const [isLoading, setIsLoading] = useState(true);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [userId, setUserId] = useState(null);
    const [firebaseDb, setFirebaseDb] = useState(null);
    const [showErrorModal, setShowErrorModal] = useState(false);
    const [isAILoading, setIsAILoading] = useState(false);

    const [formData, setFormData] = useState({
        name: '',
        whatsapp: '',
        email: '',
        responsibleEmail: '',
        ministryGroup: '',
        desiredSpace: '',
        notes: '',
        timeSlot: ''
    });

    // Initialize Firebase and Auth
    useEffect(() => {
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (Object.keys(firebaseConfig).length > 0) {
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                setFirebaseDb(db);

                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase Auth Error:", error);
                        }
                    }
                    setIsAuthReady(true);
                });

                return () => unsubscribe();
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
            }
        } else {
            console.error("Firebase config is not available. Please check the environment setup.");
            setIsAuthReady(true);
        }
    }, []);

    // Fetch data from Firestore
    useEffect(() => {
        if (!isAuthReady || !userId || !firebaseDb) return;

        setIsLoading(true);
        const appointmentsCollectionRef = collection(firebaseDb, 'artifacts', __app_id, 'users', userId, 'appointments');

        const unsubscribe = onSnapshot(appointmentsCollectionRef, (snapshot) => {
            const newEvents = {};
            snapshot.forEach((doc) => {
                const event = doc.data();
                const dateKey = event.date;
                if (!newEvents[dateKey]) {
                    newEvents[dateKey] = [];
                }
                newEvents[dateKey].push({ ...event, id: doc.id });
            });
            setEvents(newEvents);
            setIsLoading(false);
        }, (error) => {
            console.error("Error fetching data from Firestore:", error);
            setIsLoading(false);
        });

        return () => unsubscribe();
    }, [isAuthReady, userId, firebaseDb]);

    // --- Calendar Logic ---

    // Get all days of the current month
    const start = startOfMonth(currentDate);
    const end = endOfMonth(currentDate);
    const daysInMonth = eachDayOfInterval({ start, end });

    // Calculate empty days at the start of the month
    const firstDayIndex = getDay(start);
    const emptyDays = Array(firstDayIndex).fill(null);

    // --- Event Handling ---

    // Opens the modal when a day is clicked
    const handleDayClick = (day) => {
        setSelectedDate(day);
        setIsModalOpen(true);
    };

    // Updates the form data as the user types
    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setFormData(prevFormData => ({
            ...prevFormData,
            [name]: value
        }));
    };

    // Adds a new event to the selected day in Firestore and sends to webhook
    const handleAddEvent = async (e) => {
        e.preventDefault(); // Prevents page reload
        if (Object.values(formData).some(field => field.trim() === '')) {
            setShowErrorModal(true);
            return;
        }

        const dateKey = format(selectedDate, 'yyyy-MM-dd');
        const newEvent = { ...formData, date: dateKey };
        
        if (!userId || !firebaseDb) {
            console.error("Firestore is not initialized or user is not authenticated.");
            return;
        }

        try {
            // Save to Firestore
            const docRef = doc(collection(firebaseDb, 'artifacts', __app_id, 'users', userId, 'appointments'));
            await setDoc(docRef, newEvent);

            // Send data to webhook
            const webhookUrl = 'https://eou7w4paj8nm4ch.m.pipedream.net';
            const webhookData = {
                nome: formData.name,
                telefone: formData.whatsapp,
                email: formData.email,
                emailResponsavel: formData.responsibleEmail,
                ministerioGrupo: formData.ministryGroup,
                espacoDesejado: formData.desiredSpace,
                observacoes: formData.notes,
                horario: formData.timeSlot,
                data: format(selectedDate, 'yyyy-MM-dd')
            };

            const webhookResponse = await fetch(webhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(webhookData),
            });

            if (!webhookResponse.ok) {
                console.error(`Erro ao enviar para o webhook: ${webhookResponse.statusText}`);
            }

        } catch (e) {
            console.error("Error adding document or sending webhook: ", e);
        }

        handleCloseModal();
    };

    // Deletes an event from Firestore
    const handleDeleteEvent = async (eventId) => {
        if (!userId || !firebaseDb) {
            console.error("Firestore is not initialized or user is not authenticated.");
            return;
        }
        
        try {
            const docRef = doc(firebaseDb, 'artifacts', __app_id, 'users', userId, 'appointments', eventId);
            await deleteDoc(docRef);
        } catch (e) {
            console.error("Error deleting document: ", e);
        }
    };

    // Closes the modal and resets form data
    const handleCloseModal = () => {
        setIsModalOpen(false);
        setSelectedDate(null);
        setFormData({
            name: '',
            whatsapp: '',
            email: '',
            responsibleEmail: '',
            ministryGroup: '',
            desiredSpace: '',
            notes: '',
            timeSlot: ''
        });
    };

    // Checks if a day has events
    const hasEventsForDay = (day) => {
        const dateKey = format(day, 'yyyy-MM-dd');
        return events[dateKey] && events[dateKey].length > 0;
    };
    
    // --- Navigation ---

    // Goes to the previous month
    const handlePrevMonth = () => {
        setCurrentDate(prevDate => {
            const newDate = new Date(prevDate);
            newDate.setMonth(prevDate.getMonth() - 1);
            return newDate;
        });
    };

    // Goes to the next month
    const handleNextMonth = () => {
        setCurrentDate(prevDate => {
            const newDate = new Date(prevDate);
            newDate.setMonth(prevDate.getMonth() + 1);
            return newDate;
        });
    };

    // --- Gemini API Integration ---
    const handleGeminiExpansion = async () => {
        const userPrompt = `Expande a seguinte nota de evento, tornando-a mais detalhada e descritiva. Mantém o tom profissional e formal. Nota: ${formData.notes}`;
        setIsAILoading(true);

        let chatHistory = [];
        chatHistory.push({ role: "user", parts: [{ text: userPrompt }] });
        const payload = { contents: chatHistory };
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        let response;
        try {
            response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API error: ${response.statusText}`);
            }

            const result = await response.json();
            const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;

            if (text) {
                setFormData(prevFormData => ({
                    ...prevFormData,
                    notes: text
                }));
            }
        } catch (error) {
            console.error("Erro ao chamar a API do Gemini:", error);
        } finally {
            setIsAILoading(false);
        }
    };

    return (
        <div className="min-h-screen bg-gray-100 p-4 flex justify-center items-start">
            <div className="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-lg mt-10">
                 {/* User ID display for collaborative purposes */}
                {userId && (
                    <div className="text-center text-sm text-gray-500 mb-4">
                        <p>ID do Utilizador: <span className="font-mono bg-gray-200 px-2 py-1 rounded-md">{userId}</span></p>
                    </div>
                )}
                
                {/* Loading indicator */}
                {isLoading && (
                    <div className="absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center rounded-3xl z-40">
                        <p className="text-gray-700 text-lg font-semibold">Carregando...</p>
                    </div>
                )}

                {/* Calendar Header */}
                <div className="flex items-center justify-between mb-6">
                    <button onClick={handlePrevMonth} className="p-2 rounded-full hover:bg-gray-200 transition-all duration-200">
                        <ChevronLeft className="h-6 w-6 text-gray-600" />
                    </button>
                    <h2 className="text-3xl font-extrabold text-gray-800">
                        {format(currentDate, 'MMMM yyyy', { locale: ptBR })}
                    </h2>
                    <button onClick={handleNextMonth} className="p-2 rounded-full hover:bg-gray-200 transition-all duration-200">
                        <ChevronRight className="h-6 w-6 text-gray-600" />
                    </button>
                </div>

                {/* Days of the week */}
                <div className="grid grid-cols-7 gap-2 text-center text-sm font-semibold text-gray-500 mb-2">
                    {['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].map(day => (
                        <div key={day}>{day}</div>
                    ))}
                </div>

                {/* Calendar Grid */}
                <div className="grid grid-cols-7 gap-2">
                    {/* Empty days at the beginning of the month */}
                    {emptyDays.map((_, index) => (
                        <div key={`empty-${index}`} className="aspect-square"></div>
                    ))}
                    {/* Days of the month */}
                    {daysInMonth.map(day => (
                        <div
                            key={day.toISOString()}
                            onClick={() => handleDayClick(day)}
                            className={`
                                p-2 text-center rounded-xl cursor-pointer transition-all duration-200
                                font-medium flex items-center justify-center relative aspect-square
                                ${isSameDay(day, new Date()) ? 'bg-blue-600 text-white font-bold shadow-md' : 'text-gray-800 hover:bg-blue-100'}
                                ${hasEventsForDay(day) && 'ring-2 ring-offset-2 ring-purple-500'}
                            `}
                        >
                            {format(day, 'd')}
                            {/* Visual indicator for events */}
                            {hasEventsForDay(day) && (
                                <span className="absolute bottom-1 right-1 h-2 w-2 bg-purple-500 rounded-full animate-pulse"></span>
                            )}
                        </div>
                    ))}
                </div>

                {/* Modal for adding/viewing events */}
                {isModalOpen && selectedDate && (
                    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-2xl p-8 max-w-lg w-full shadow-lg relative">
                            <button onClick={handleCloseModal} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                                <X size={24} />
                            </button>
                            <h3 className="text-2xl font-bold mb-4">
                                Agendar para {format(selectedDate, 'd MMMM, yyyy', { locale: ptBR })}
                            </h3>
                            
                            {/* Display existing events */}
                            {events[format(selectedDate, 'yyyy-MM-dd')]?.length > 0 && (
                                <div className="mb-6">
                                    <h4 className="text-lg font-semibold mb-2">Eventos Agendados</h4>
                                    <ul className="space-y-2 max-h-40 overflow-y-auto pr-2">
                                        {events[format(selectedDate, 'yyyy-MM-dd')].map(event => (
                                            <li key={event.id} className="flex flex-col p-4 bg-gray-100 rounded-lg shadow-sm">
                                                <div className="flex items-center justify-between mb-2">
                                                    <span className="font-bold text-blue-600">{event.name}</span>
                                                    <button onClick={() => handleDeleteEvent(event.id)} className="text-red-500 hover:text-red-700 transition-colors">
                                                        <Trash2 size={18} />
                                                    </button>
                                                </div>
                                                <div className="text-sm text-gray-600 space-y-1">
                                                    <p><span className="font-medium">WhatsApp:</span> {event.whatsapp}</p>
                                                    <p><span className="font-medium">Email:</span> {event.email}</p>
                                                    <p><span className="font-medium">Responsável:</span> {event.responsibleEmail}</p>
                                                    <p><span className="font-medium">Ministério/Grupo:</span> {event.ministryGroup}</p>
                                                    <p><span className="font-medium">Espaço:</span> {event.desiredSpace}</p>
                                                    <p><span className="font-medium">Horário:</span> {event.timeSlot}</p>
                                                    <p><span className="font-medium">Observações:</span> {event.notes || 'N/A'}</p>
                                                </div>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            )}

                            {/* Add new event form */}
                            <form onSubmit={handleAddEvent} className="space-y-4">
                                <h4 className="text-lg font-semibold border-t pt-4">Adicionar Novo Agendamento</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input
                                        type="text"
                                        name="name"
                                        value={formData.name}
                                        onChange={handleInputChange}
                                        className="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow"
                                        placeholder="Nome"
                                    />
                                    <input
                                        type="tel"
                                        name="whatsapp"
                                        value={formData.whatsapp}
                                        onChange={handleInputChange}
                                        className="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow"
                                        placeholder="WhatsApp"
                                    />
                                    <input
                                        type="email"
                                        name="email"
                                        value={formData.email}
                                        onChange={handleInputChange}
                                        className="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow"
                                        placeholder="Email"
                                    />
                                    <input
                                        type="email"
                                        name="responsibleEmail"
                                        value={formData.responsibleEmail}
                                        onChange={handleInputChange}
                                        className="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow"
                                        placeholder="Email do Responsável"
                                    />
                                    <input
                                        type="text"
                                        name="ministryGroup"
                                        value={formData.ministryGroup}
                                        onChange={handleInputChange}
                                        className="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow"
                                        placeholder="Ministério / Grupo"
                                    />
                                    <select
                                        name="desiredSpace"
                                        value={formData.desiredSpace}
                                        onChange={handleInputChange}
                                        className="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow"
                                    >
                                        <option value="" disabled>Selecione um espaço</option>
                                        <option value="Lounge">Lounge</option>
                                        <option value="Templo">Templo</option>
                                        <option value="Sala Alta para até 25 pessoas">Sala Alta para até 25 pessoas</option>
                                        <option value="Sala ID para até 15 pessoas">Sala ID para até 15 pessoas</option>
                                        <option value="Reserva de Data para Cantina">Reserva de Data para Cantina</option>
                                        <option value="Outro">Outro</option>
                                    </select>
                                    <select
                                        name="timeSlot"
                                        value={formData.timeSlot}
                                        onChange={handleInputChange}
                                        className="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow"
                                    >
                                        <option value="" disabled>Selecione um horário</option>
                                        <option value="08:00 - 18:00">08h00 - 18h00</option>
                                        <option value="18:00 - 22:00">18h00 - 22h00</option>
                                    </select>
                                </div>
                                <div>
                                    <label htmlFor="notes" className="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                                    <div className="relative">
                                        <textarea
                                            id="notes"
                                            name="notes"
                                            value={formData.notes}
                                            onChange={handleInputChange}
                                            className="w-full p-3 pr-12 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow resize-y"
                                            rows="3"
                                            placeholder="Adicione uma nota rápida..."
                                        ></textarea>
                                        <button
                                            type="button"
                                            onClick={handleGeminiExpansion}
                                            disabled={isAILoading || formData.notes.trim() === ''}
                                            className="absolute top-2 right-2 p-2 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors duration-200 disabled:bg-gray-400"
                                            title="Expandir nota com IA"
                                        >
                                            {isAILoading ? (
                                                <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                            ) : (
                                                <Sparkles size={20} />
                                            )}
                                        </button>
                                    </div>
                                    {isAILoading && (
                                        <p className="text-center text-sm text-gray-500 mt-2">A expandir a nota com IA...</p>
                                    )}
                                </div>
                                <button
                                    type="submit"
                                    className="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-xl hover:bg-blue-700 transition-colors duration-200 flex items-center justify-center gap-2"
                                >
                                    <Plus size={18} /> Agendar Evento
                                </button>
                            </form>
                        </div>
                    </div>
                )}

                {/* Custom Alert Modal for form validation */}
                {showErrorModal && (
                    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-2xl p-8 max-w-sm w-full shadow-lg text-center relative">
                             <div className="flex justify-center mb-4">
                                <AlertTriangle size={48} className="text-red-500" />
                            </div>
                            <h4 className="text-xl font-bold mb-2">Campos Incompletos</h4>
                            <p className="text-gray-700 mb-4">Por favor, preencha todos os campos do formulário para adicionar um agendamento.</p>
                            <button
                                onClick={() => setShowErrorModal(false)}
                                className="w-full bg-red-500 text-white font-semibold py-3 px-4 rounded-xl hover:bg-red-600 transition-colors"
                            >
                                OK
                            </button>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
}
